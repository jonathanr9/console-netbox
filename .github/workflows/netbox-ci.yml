name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  tests:
    name: Tests et Analyse de Code
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0  # Nécessaire pour SonarCloud

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.1'
        coverage: xdebug
        tools: phpunit, phpcs

    - name: Lint PHP
      run: php -l api.php

    - name: Vérification du style de code PHP
      run: phpcs --standard=PSR2 api.php

    - name: Exécuter les tests PHPUnit
      run: |
        mkdir -p build/logs
        phpunit --log-junit build/logs/junit.xml

    - name: SonarCloud Scan
      uses: sonarsource/sonarcloud-github-action@master
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      with:
        projectBaseDir: .
        args: >
          -Dsonar.organization=votre-organization
          -Dsonar.projectKey=votre-project-key
          -Dsonar.php.coverage.reportPaths=build/logs/junit.xml
          -Dsonar.sources=.
          -Dsonar.test.exclusions=tests/**
          -Dsonar.tests=tests/